<!DOCTYPE html><html lang="[&quot;en&quot;,&quot;zh-TW&quot;,&quot;default&quot;]"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.0.0-rc.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.0.0-rc.0" type="image/png" sizes="32x32"><meta name="description" content="Share experience in software development">
<meta property="og:type" content="website">
<meta property="og:title" content="ExpShare">
<meta property="og:url" content="https://newjerseystyle.github.io/index.html">
<meta property="og:site_name" content="ExpShare">
<meta property="og:description" content="Share experience in software development">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="NewJerseyStyle">
<meta property="article:tag" content="development implementation iot c++ python tutorial">
<meta name="twitter:card" content="summary"><meta name="keywords" content="NewJerseyStyle, ExpShare"><meta name="description" content="Share experience in software development"><title>ExpShare | Playground of NewJerseyStyle</title><link ref="canonical" href="https://newjerseystyle.github.io/index.html"><link rel="alternate" href="/atom.xml" type="application/atom+xml"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.0.0-rc.0"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 4.2.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/softdev/"><span class="header-nav-menu-item__icon"><i class="fas fa-laptop-code"></i></span><span class="header-nav-menu-item__text">Coding</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/toolz/"><span class="header-nav-menu-item__icon"><i class="fas fa-toolbox"></i></span><span class="header-nav-menu-item__text">Tools</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">Tags</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">ExpShare</div><div class="header-banner-info__subtitle">Playground of NewJerseyStyle</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/en/2020/Installing-Pytorch-with-ROCm-3.3.0-on-Ubuntu-18.04/">Installing Pytorch with ROCm 3.3.0 on Ubuntu 18.04</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-04-18</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-04-22</span></span></div></header><div class="post-body"><div class="post-excerpt"><!-- # Installing Pytorch with ROCm on Ubuntu 18.04 -->

        <h2 id="Goal"   >
          <a href="#Goal" class="heading-link"><i class="fas fa-link"></i></a>Goal</h2>
      <p>Now I have got my RX 580 ready for TensorFlow, and I brought a VEGA 56 with 10.54 TFLOPS for FP32 from newegg.com at price 266 USD. Let’s install Pytorch this time? Well, there will be few problem you may encounter like I did during installation of Pytorch on top of ROCm 3.3.0. Watch me how to fix them.</p>
<p>First of all, install ROCm 3.3.0 (refer to <a href="/en/2020/Installing-ROCm-for-Deep-learning-on-Ubuntu-18.04/">previous tutorial</a>), requirements are the same.</p>

        <h2 id="Install-Pytorch"   >
          <a href="#Install-Pytorch" class="heading-link"><i class="fas fa-link"></i></a>Install Pytorch</h2>
      <p>We follow the instructions from <span class="exturl"><a class="exturl__link"   href="https://rocm-documentation.readthedocs.io/en/latest/Deep_learning/Deep-learning.html"  target="_blank" rel="noopener">ROCm</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> first, and I will add solution to problem I encountered.</p>
<p><strong>You will need to have 16 GB RAM or more to finish the whole compile, install and test process.</strong></p>

        <h2 id="Step-One"   >
          <a href="#Step-One" class="heading-link"><i class="fas fa-link"></i></a>Step One</h2>
      
        <h3 id="Install-Docker"   >
          <a href="#Install-Docker" class="heading-link"><i class="fas fa-link"></i></a>Install Docker</h3>
      <p>You will need Docker to finish the installation. Docker is similar to virtual machine simulate a operating system environment isolate from your computer but Docker is much lighter and faster, <span class="exturl"><a class="exturl__link"   href="https://www.docker.com/resources/what-container"  target="_blank" rel="noopener">learn more from their docuements</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>.</p>
<p>Install <span class="exturl"><a class="exturl__link"   href="https://docs.docker.com/engine/install/ubuntu/"  target="_blank" rel="noopener">Docker with instructions from Docker official document</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> or you can use their convenience script. <strong>And examine scripts downloaded from the internet before running them locally.</strong> Make sure no one added a line to install a trojan into your computer.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line"></span><br><span class="line">$ sudo sh get-docker.sh</span><br></pre></td></tr></table></div></figure>

        <h3 id="Install-ROCm-Dev-package"   >
          <a href="#Install-ROCm-Dev-package" class="heading-link"><i class="fas fa-link"></i></a>Install ROCm-Dev package</h3>
      <p>We are going to compile Pytorch from source, it requires <code>rocm-dev</code> package.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line"></span><br><span class="line">$ sudo apt-get upgrade</span><br><span class="line"></span><br><span class="line">$ sudo apt-get install rocm-dev</span><br></pre></td></tr></table></div></figure>

        <h2 id="Step-Two"   >
          <a href="#Step-Two" class="heading-link"><i class="fas fa-link"></i></a>Step Two</h2>
      
        <h3 id="Prepare-environment-for-compiling"   >
          <a href="#Prepare-environment-for-compiling" class="heading-link"><i class="fas fa-link"></i></a>Prepare environment for compiling</h3>
      <p>Now we get the compilation environment for ROCm 3.3.0. The official document is not up-to-date which tells you to run <code>docker pull rocm/pytorch:rocm3.0_ubuntu16.04_py3.6_pytorch</code>. You should go to <span class="exturl"><a class="exturl__link"   href="https://hub.docker.com/r/rocm/pytorch/tags"  target="_blank" rel="noopener">their DockerHub</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> and make sure the tag <code>rocm3.0_ubuntu16.04_py3.6_pytorch</code> is what you need. For ROCm 3.3.0 I need <code>rocm3.3_ubuntu16.04_py3.6_pytorch</code> so I run:</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker pull rocm/pytorch:rocm3.3_ubuntu16.04_py3.6_pytorch</span><br></pre></td></tr></table></div></figure>

        <h3 id="Prepare-source-code-for-compiling"   >
          <a href="#Prepare-source-code-for-compiling" class="heading-link"><i class="fas fa-link"></i></a>Prepare source code for compiling</h3>
      <p>Now clone the source code of Pytorch with Git, do <code>sudo apt-get install git</code> if you don’t have git.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~</span><br><span class="line"></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/pytorch/pytorch.git</span><br></pre></td></tr></table></div></figure>
<p>And then clone the other required source code automatically.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> pytorch</span><br><span class="line"></span><br><span class="line">$ git submodule init</span><br><span class="line"></span><br><span class="line">$ git submodule update</span><br></pre></td></tr></table></div></figure>
<p>I would suggest you to run <code>git submodule update --init --recursive</code> instead of <code>git submodule update</code> as some of the required source code may have their own required repository which needs to download with <code>--recursive</code> flag.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git submodule update --init --recursive</span><br></pre></td></tr></table></div></figure>


        <h2 id="Step-Three"   >
          <a href="#Step-Three" class="heading-link"><i class="fas fa-link"></i></a>Step Three</h2>
      
        <h3 id="Enter-environment-for-compiling"   >
          <a href="#Enter-environment-for-compiling" class="heading-link"><i class="fas fa-link"></i></a>Enter environment for compiling</h3>
      <p>Just run this:</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -it -v <span class="variable">$HOME</span>:/data --privileged --rm --device=/dev/kfd --device=/dev/dri --group-add video rocm/pytorch:rocm3.0_ubuntu16.04_py3.6_pytorch</span><br></pre></td></tr></table></div></figure>
<p>And you will get something look another terminal:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;#</span><br></pre></td></tr></table></div></figure>
<p>Now we change to the mounted source code directory:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;# cd &#x2F;data&#x2F;pytorch</span><br></pre></td></tr></table></div></figure>

        <h3 id="We-now-start-building"   >
          <a href="#We-now-start-building" class="heading-link"><i class="fas fa-link"></i></a>We now start building</h3>
      <p>However you may encounter some problems. Here was my solution in 20 Apr 2020. I hope the problems have already been fixed while you read this, but in case it isn’t…</p>

        <h4 id="Patch-1"   >
          <a href="#Patch-1" class="heading-link"><i class="fas fa-link"></i></a>Patch 1</h4>
      <p>Depends on your GPU, export the right code for it. You can check the code by running <code>rocminfo</code> on your host (out side the docker) on another terminal. Or you can find it <span class="exturl"><a class="exturl__link"   href="https://llvm.org/docs/AMDGPUUsage.html#processors"  target="_blank" rel="noopener">here</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> Ctrl-F search your GPU. <code>gfx803</code> for RX 580 and <code>gfx900</code> for VEGA 56.</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;# export HCC_AMDGPU_TARGET&#x3D;gfx900</span><br></pre></td></tr></table></div></figure>

        <h4 id="Patch-2"   >
          <a href="#Patch-2" class="heading-link"><i class="fas fa-link"></i></a>Patch 2</h4>
      <p>Check you have <code>hip_version.h</code> in the path <code>${ROCM_DIR}/include/hip/hip_version.h</code>, add such a file if it does not exist. Otherwise compilation may fail at <code>78%</code>.</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;# nano $&#123;ROCM_DIR&#125;&#x2F;include&#x2F;hip&#x2F;hip_version.h</span><br></pre></td></tr></table></div></figure>
<p>It sould look like this.</p>
<figure class="highlight c++"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HIP_VERSION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HIP_VERSION 330</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></div></figure>
<p><code>330</code> here means ROCm 3.3.0, change it to <code>300</code> for ROCm 3.0.0, depends on your ROCm version.<br>In case you need to add it:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;# mkdir -p $&#123;ROCM_DIR&#125;&#x2F;include&#x2F;hip&#x2F;</span><br><span class="line"></span><br><span class="line">root@f78375b1c487:&#x2F;# nano $&#123;ROCM_DIR&#125;&#x2F;include&#x2F;hip&#x2F;hip_version.h</span><br></pre></td></tr></table></div></figure>

        <h4 id="Patch-3"   >
          <a href="#Patch-3" class="heading-link"><i class="fas fa-link"></i></a>Patch 3</h4>
      <p>Make sure packages such as <code>rccl</code> have installed in the docker container, otherwise compiler will not be able to find the libaray and fail the compilation at around <code>79%</code>.</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;# apt install rocm-libs miopen-hip rccl</span><br></pre></td></tr></table></div></figure>

        <h3 id="Start-compiling"   >
          <a href="#Start-compiling" class="heading-link"><i class="fas fa-link"></i></a>Start compiling</h3>
      <p>A automated script is provided, just run the following command will build and install everything to the docker container.</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;# .jenkins&#x2F;pytorch&#x2F;build.sh</span><br></pre></td></tr></table></div></figure>
<p>You may take a break and had tea time or go hiking, It takes more than one hour on my i5-4570.</p>

        <h2 id="Step-Four"   >
          <a href="#Step-Four" class="heading-link"><i class="fas fa-link"></i></a>Step Four</h2>
      <p>Before we finish everything, we need to run a test.</p>

        <h3 id="Test"   >
          <a href="#Test" class="heading-link"><i class="fas fa-link"></i></a>Test</h3>
      <p>You may run script for testing…</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;# PYTORCH_TEST_WITH_ROCM&#x3D;1 python test&#x2F;run_test.py --verbose</span><br></pre></td></tr></table></div></figure>
<p>And it may say <code>Import Error : no module named torch</code> no worry, let’s fix it.</p>

        <h3 id="Patch-1-1"   >
          <a href="#Patch-1-1" class="heading-link"><i class="fas fa-link"></i></a>Patch 1</h3>
      <p>In order to pass the test, you will need Ninja, the container does not contain Ninja while I was running it on 19 Apr 2020, so I need to install it myself (The strange thing is, Ninja should be used in compiling to speed up everything. Cannot see why it is not installed before running testing.).</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;# apt-get install -y ninja-build</span><br></pre></td></tr></table></div></figure>

        <h3 id="Patch-2-1"   >
          <a href="#Patch-2-1" class="heading-link"><i class="fas fa-link"></i></a>Patch 2</h3>
      <p>Check your Python version</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;# python -V</span><br><span class="line">Python 2.7.18</span><br><span class="line">root@f78375b1c487:&#x2F;# python3 -V</span><br><span class="line">Python 3.5.8</span><br><span class="line">root@f78375b1c487:&#x2F;# python3.6 -V</span><br><span class="line">Python 3.6.10</span><br></pre></td></tr></table></div></figure>
<p>Since the Pytorch was compiled and installed for Python 3.6, you need to use Python 3.6 for running the test.</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;# PYTORCH_TEST_WITH_ROCM&#x3D;1 python3.6 test&#x2F;run_test.py --verbose</span><br></pre></td></tr></table></div></figure>

        <h3 id="Patch-3-1"   >
          <a href="#Patch-3-1" class="heading-link"><i class="fas fa-link"></i></a>Patch 3</h3>
      <p>If you do not have 16 GB RAM, it will use up all the memeory and <code>malloc</code> will raise error for unable to allocate memory.</p>

        <h2 id="Step-Five"   >
          <a href="#Step-Five" class="heading-link"><i class="fas fa-link"></i></a>Step Five</h2>
      
        <h3 id="Install-torchvision"   >
          <a href="#Install-torchvision" class="heading-link"><i class="fas fa-link"></i></a>Install torchvision</h3>
      <p>Try to install it and you suppose to see it already installed with your compilation and installation of Pytorch.</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@f78375b1c487:&#x2F;# pip install torchvision</span><br></pre></td></tr></table></div></figure>

        <h3 id="Save-the-container"   >
          <a href="#Save-the-container" class="heading-link"><i class="fas fa-link"></i></a>Save the container</h3>
      <p>Exit your container with Ctrl-D and use the container ID to save it into image so you can use it for different project and prevent environment contamination of different dependencies. The container ID is the hash showing in your terminal for container, <code>f78375b1c487</code> for mine.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker commit f78375b1c487 -m <span class="string">'pytorch installed'</span></span><br></pre></td></tr></table></div></figure>
<p>Change <code>f78375b1c487</code> to your container ID.</p>

        <h2 id="DONE"   >
          <a href="#DONE" class="heading-link"><i class="fas fa-link"></i></a>DONE</h2>
      <p>Pytorch time! (&gt;w&lt;)b</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/en/2020/Installing-ROCm-3.3.0-for-Deep-learning-on-Ubuntu-18.04/">Installing ROCm 3.3.0 for Deep learning on Ubuntu 18.04</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-04-18</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-04-22</span></span></div></header><div class="post-body"><div class="post-excerpt"><!-- # Installing ROCm for Deep learning on Ubuntu 18.04 -->

        <h2 id="Goal"   >
          <a href="#Goal" class="heading-link"><i class="fas fa-link"></i></a>Goal</h2>
      <p>We all know AMD <span class="exturl"><a class="exturl__link"   href="https://www.techpowerup.com/gpu-specs/radeon-rx-vega-56.c2993"  target="_blank" rel="noopener">VEGA 56</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> and <span class="exturl"><a class="exturl__link"   href="https://www.techpowerup.com/gpu-specs/radeon-rx-vega-64.c2871"  target="_blank" rel="noopener">VEGA 64</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> are powerful GPUs are competitive to <span class="exturl"><a class="exturl__link"   href="https://www.techpowerup.com/gpu-specs/geforce-rtx-2080-ti.c3305"  target="_blank" rel="noopener">NVIDIA 2080 Ti</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>, the <span class="exturl"><a class="exturl__link"   href="https://www.techpowerup.com/gpu-specs/radeon-vii.c3358"  target="_blank" rel="noopener">Radeon VII</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> is even more powerful with 13.44 TFLOPS FP32 (float) performance (Theoretical) and price at 699 USD.</p>
<p>I was thinking about having a Deep Learning machine, and I looked at the price for NVIDIA 2080 Ti, it is around 1548 USD here. So I made a call to my friend who sells 2nd hand electronic stuff and get a <span class="exturl"><a class="exturl__link"   href="https://www.techpowerup.com/gpu-specs/radeon-rx-580.c2938"  target="_blank" rel="noopener">AMD Radeon RX 580</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> with around 100 USD. RX 580 is a cost-effective card to get 6 TFLOPS performance.</p>
<p>But, how to fit it with TensorFlow or Pytorch? CUDA does not agree with AMD GPUs. But no worries, I have found ROCm for AMD GPUs to replace CUDA.</p>

        <h2 id="Requirements"   >
          <a href="#Requirements" class="heading-link"><i class="fas fa-link"></i></a>Requirements</h2>
      <p>It is so excited to run TensorFlow on AMD GPU. But here are some important notes:</p>
<ul>
<li>Only new CPUs are supported as it requires PCIe Gen3 and PCIe Atomics</li>
<li>Only new GPUs are supported because old GPUs are too poor in performance</li>
<li>Use Linux with kernel 4.17 or above (Or you will have a hard time with it)</li>
</ul>

        <h3 id="Supported-CPUs"   >
          <a href="#Supported-CPUs" class="heading-link"><i class="fas fa-link"></i></a>Supported CPUs</h3>
      <ul>
<li>AMD Ryzen CPUs</li>
<li>The CPUs in AMD Ryzen APUs</li>
<li>AMD Ryzen Threadripper CPUs</li>
<li>AMD EPYC CPUs</li>
<li>Intel Xeon E7 v3 or newer CPUs</li>
<li>Intel Xeon E5 v3 or newer CPUs</li>
<li>Intel Xeon E3 v3 or newer CPUs</li>
<li>Intel Core i7 v4, Core i5 v4, Core i3 v4 or newer CPUs (i.e. Haswell family or newer)</li>
<li>Some Ivy Bridge-E systems</li>
</ul>
<p>Refer to <span class="exturl"><a class="exturl__link"   href="https://github.com/RadeonOpenCompute/ROCm#supported-cpus"  target="_blank" rel="noopener">GitHub of ROCm CPU section</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>. What are those “Some Ivy Bridge-E systems”? I don’t know too. You may Email them for support on that. You may see some older CPUs are limited supported, but I would suggest you don’t waste your time on that unless you want to contribute in ROCm to make it support older CPUs. It will make your life harder.</p>

        <h3 id="Supported-GPUs"   >
          <a href="#Supported-GPUs" class="heading-link"><i class="fas fa-link"></i></a>Supported GPUs</h3>
      <ul>
<li>GFX8 GPUs<ul>
<li>“Fiji” chips, such as on the AMD Radeon R9 Fury X and Radeon Instinct MI8</li>
<li>“Polaris 10” chips, such as on the AMD Radeon RX 580 and Radeon Instinct MI6</li>
</ul>
</li>
<li>GFX9 GPUs<ul>
<li>“Vega 10” chips, such as on the AMD Radeon RX Vega 64 and Radeon Instinct MI25</li>
<li>“Vega 7nm” chips, such as on the Radeon Instinct MI50, Radeon Instinct MI60 or AMD Radeon VII</li>
</ul>
</li>
</ul>
<p>Refer to <span class="exturl"><a class="exturl__link"   href="https://github.com/RadeonOpenCompute/ROCm#supported-gpus"  target="_blank" rel="noopener">GitHub of ROCm GPU section</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>. Few GFX8 and GFX7 GPUs are supported unofficially (if you got problem, no help, no guarantee).</p>

        <h2 id="Install-ROCm"   >
          <a href="#Install-ROCm" class="heading-link"><i class="fas fa-link"></i></a>Install ROCm</h2>
      
        <h3 id="Things-I-got"   >
          <a href="#Things-I-got" class="heading-link"><i class="fas fa-link"></i></a>Things I got</h3>
      <p>I got a i5-4570 for CPU (another 2nd hand computer with 140 USD) and RX 580 for GPU and installed Ubuntu Server 18.04.</p>
<p>The <span class="exturl"><a class="exturl__link"   href="https://rocm-documentation.readthedocs.io/en/latest/Installation_Guide/Installation-Guide.html#ubuntu"  target="_blank" rel="noopener">official tutorial</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> will be just fine for installnig ROCm and TensorFlow. But you will encounter problem in Pytorch (which is the reason I write this tutorial, I gave up on the first time, and this time I find <a href="/en/2020/Installing-Pytorch-with-ROCm-on-Ubuntu-18.04/">solution</a>).</p>

        <h3 id="Step-one"   >
          <a href="#Step-one" class="heading-link"><i class="fas fa-link"></i></a>Step one</h3>
      <blockquote>
<p>Note the ROCm version you install, I am installing ROCm 3.3.0  This information will be useful during Pytorch installation.</p>
</blockquote>
<p>Update system, install <code>libnuma-dev</code> and reboot:</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt update</span><br><span class="line"></span><br><span class="line">$ sudo apt dist-upgrade</span><br><span class="line"></span><br><span class="line">$ sudo apt install libnuma-dev</span><br><span class="line"></span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></div></figure>

        <h3 id="Step-two"   >
          <a href="#Step-two" class="heading-link"><i class="fas fa-link"></i></a>Step two</h3>
      <p>Add the ROCm apt repository.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget -q -O - http://repo.radeon.com/rocm/apt/debian/rocm.gpg.key | sudo apt-key add -</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'deb [arch=amd64] http://repo.radeon.com/rocm/apt/debian/ xenial main'</span> | sudo te</span><br></pre></td></tr></table></div></figure>
<p>Install ROCm</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt update</span><br><span class="line"></span><br><span class="line">$ sudo apt install rocm-dkms</span><br></pre></td></tr></table></div></figure>


        <h3 id="Step-three"   >
          <a href="#Step-three" class="heading-link"><i class="fas fa-link"></i></a>Step three</h3>
      <p>Grant yourself permission for accessing your GPU</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo usermod -a -G video <span class="variable">$LOGNAME</span></span><br></pre></td></tr></table></div></figure>
<p>If you need to add more users, check the <span class="exturl"><a class="exturl__link"   href="https://rocm-documentation.readthedocs.io/en/latest/Installation_Guide/Installation-Guide.html#ubuntu"  target="_blank" rel="noopener">document</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>Reboot</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo reboot</span><br></pre></td></tr></table></div></figure>


        <h3 id="Step-four"   >
          <a href="#Step-four" class="heading-link"><i class="fas fa-link"></i></a>Step four</h3>
      <p>Test the ROCm installation.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /opt/rocm/bin/rocminfo</span><br><span class="line">$ /opt/rocm/opencl/bin/x86_64/clinfo</span><br></pre></td></tr></table></div></figure>
<p>You should see something like report.</p>
<p>Add ROCm to environment PATH:</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'export PATH=$PATH:/opt/rocm/bin:/opt/rocm/profiler/bin:/opt/rocm/opencl/bin/x86_64'</span> |</span><br><span class="line">&gt; sudo tee -a /etc/profile.d/rocm.sh</span><br></pre></td></tr></table></div></figure>


        <h2 id="Install-TensorFlow"   >
          <a href="#Install-TensorFlow" class="heading-link"><i class="fas fa-link"></i></a>Install TensorFlow</h2>
      <p>This is simple with two steps, get some important libraries and install TensorFlow through <code>pip</code>. Refer to <span class="exturl"><a class="exturl__link"   href="https://rocm-documentation.readthedocs.io/en/latest/Deep_learning/Deep-learning.html"  target="_blank" rel="noopener">ROCm Doc</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt update</span><br><span class="line"></span><br><span class="line">$ sudo apt install rocm-libs miopen-hip cxlactivitylogger rccl</span><br><span class="line"></span><br><span class="line">$ sudo apt install wget python3-pip</span><br><span class="line"></span><br><span class="line">$ pip3 install --user tensorflow-rocm</span><br></pre></td></tr></table></div></figure>

<p>It now installed TensorFlow 2 (latest), you need to specify version if you need just like installing other packages in Python.</p>

        <h2 id="DONE"   >
          <a href="#DONE" class="heading-link"><i class="fas fa-link"></i></a>DONE</h2>
      <p>TensorFlow time~ (^_^)b</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/zh-TW/2020/Raspberry-Pi-%E5%8C%96%E8%BA%AB-WiFi-%E8%9B%8B/">Raspberry Pi 化身 WiFi 蛋</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-04-12</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-04-12</span></span></div></header><div class="post-body"><div class="post-excerpt"><!-- # Raspberry Pi 化身 WiFi 蛋 -->

        <h2 id="前文"   >
          <a href="#前文" class="heading-link"><i class="fas fa-link"></i></a>前文</h2>
      <p>我們已經改造 <a href="/en/2020/Raspberry-Pi-connect-to-4G-LTE/">Raspberry Pi 使用 4G 數據網路</a></p>

        <h2 id="目標"   >
          <a href="#目標" class="heading-link"><i class="fas fa-link"></i></a>目標</h2>
      <p>這次我們要讓 Raspberry Pi 將網絡分享給其他裝置，你可以選：</p>
<ul>
<li><a href="#無線路由器">製成<strong>無線</strong>路由器</a></li>
<li><a href="#有線路由器">製成路由器（有線）</a></li>
</ul>

        <h2 id="無線路由器"   >
          <a href="#無線路由器" class="heading-link"><i class="fas fa-link"></i></a>無線路由器</h2>
      <p>因為博主很懶惰，不想重複造輪子，所以無線路由器的教材就直接引用 <span class="exturl"><a class="exturl__link"   href="https://sixfab.com/using-sixfab-raspberry-p-shield-hat-as-a-wi-fi-hotspot-access-point/"  target="_blank" rel="noopener">Sixfab 的教學</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>如果你用的是早於 Raspberry Pi 3 的版本，你大概需要一個 USB 無線網路卡。</p>

        <h3 id="備份無線網絡配置"   >
          <a href="#備份無線網絡配置" class="heading-link"><i class="fas fa-link"></i></a>備份無線網絡配置</h3>
      <p>這並不是必須的步驟，不過萬一你日後想恢復原樣，這一步會很有幫助。</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp /etc/wpa_supplicant/wpa_supplicant.conf /etc/wpa_supplicant/wpa_supplicant.backup.conf</span><br></pre></td></tr></table></div></figure>


        <h3 id="配置無線網絡裝置"   >
          <a href="#配置無線網絡裝置" class="heading-link"><i class="fas fa-link"></i></a>配置無線網絡裝置</h3>
      <p>用以下指令清除舊配置</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp /dev/null /etc/wpa_supplicant/wpa_supplicant.conf</span><br></pre></td></tr></table></div></figure>
<p>將以下的新配置寫入到 <code>/etc/wpa_supplicant/wpa_supplicant.conf</code></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctrl_interface&#x3D;DIR&#x3D;&#x2F;var&#x2F;run&#x2F;wpa_supplicant GROUP&#x3D;netdev</span><br><span class="line">update_config&#x3D;1</span><br></pre></td></tr></table></div></figure>


        <h3 id="安裝-RaspAP"   >
          <a href="#安裝-RaspAP" class="heading-link"><i class="fas fa-link"></i></a>安裝 RaspAP</h3>
      <p>有一個簡單的安裝精靈 <span class="exturl"><a class="exturl__link"   href="https://github.com/billz/raspap-webgui"  target="_blank" rel="noopener">RaspAP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 跟著它的步驟去進行安裝</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -q https://git.io/voEUQ -O /tmp/raspap &amp;&amp; bash /tmp/raspap -y</span><br></pre></td></tr></table></div></figure>
<p>不過由於我本人並沒有試過這個方法，所以如果有任何疑問（例如默認的密碼、管理員界面等）還請前往 <span class="exturl"><a class="exturl__link"   href="https://sixfab.com/using-sixfab-raspberry-p-shield-hat-as-a-wi-fi-hotspot-access-point/"  target="_blank" rel="noopener">Sixfab 的教學</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 和<span class="exturl"><a class="exturl__link"   href="https://howtoraspberrypi.com/create-a-wi-fi-hotspot-in-less-than-10-minutes-with-pi-raspberry/"  target="_blank" rel="noopener">原文教學（包含故障排除章節）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="有線路由器"   >
          <a href="#有線路由器" class="heading-link"><i class="fas fa-link"></i></a>有線路由器</h2>
      <p>我自己是用的這個方法，因為感覺會比較安心，始終有線的網絡感覺會比較穩定。這一部分就要使用網絡位址轉換技術（Network Address Translation，NAT）來連接 <code>ppp0</code> 和 <code>eth0</code> 兩個網絡界面（網卡）</p>
<p>我是參考<span class="exturl"><a class="exturl__link"   href="https://raspberrypi.stackexchange.com/questions/48307/sharing-the-pis-wifi-connection-through-the-ethernet-port"  target="_blank" rel="noopener">將無線網絡分享到網線教程</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>然後將它改成將 PPP 網絡分享到網線</p>

        <h3 id="DHCP-和-DNS-伺服器"   >
          <a href="#DHCP-和-DNS-伺服器" class="heading-link"><i class="fas fa-link"></i></a>DHCP 和 DNS 伺服器</h3>
      <p>你可以選自己喜歡的諸如 <code>isc-dhcp-server</code> 之類比較複雜的，這邊直接用 <code>dnsmasq</code> 比較方便</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install dnsmasq</span><br></pre></td></tr></table></div></figure>

        <h3 id="設置網絡界面"   >
          <a href="#設置網絡界面" class="heading-link"><i class="fas fa-link"></i></a>設置網絡界面</h3>
      <p>編輯 <code>/etc/network/interfaces</code> 裡的 <code>eth0</code> 部分</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">allow-hotplug eth0  </span><br><span class="line">iface eth0 inet static  </span><br><span class="line">    address 192.168.2.1</span><br><span class="line">    netmask 255.255.255.0</span><br><span class="line">    network 192.168.2.0</span><br><span class="line">    broadcast 192.168.2.255</span><br></pre></td></tr></table></div></figure>

        <h3 id="設置-dnsmasq"   >
          <a href="#設置-dnsmasq" class="heading-link"><i class="fas fa-link"></i></a>設置 dnsmasq</h3>
      <p>先備份一下 dnsmasq 原本的設置</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig</span><br></pre></td></tr></table></div></figure>
<p>然後編輯 <code>/etc/dnsmasq.conf</code></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">interface&#x3D;eth0      # 分享到 eth0  </span><br><span class="line">listen-address&#x3D;192.168.2.1 # 和&#x2F;etc&#x2F;network&#x2F;interfaces配置的 IP 要一致  </span><br><span class="line"># Bind to the interface to make sure we aren&#39;t sending things elsewhere</span><br><span class="line">#### bind-interfaces #### BUT don&#39;t enable this.</span><br><span class="line">server&#x3D;8.8.8.8       # Forward DNS requests to Google DNS  </span><br><span class="line">domain-needed        # Don&#39;t forward short names  </span><br><span class="line"># Never forward addresses in the non-routed address spaces.</span><br><span class="line">bogus-priv</span><br><span class="line"># Assign IP addresses between 192.168.2.2 and 192.168.2.100 with a</span><br><span class="line"># 12 hour lease time</span><br><span class="line">dhcp-range&#x3D;192.168.2.2,192.168.2.100,12h</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>關於 <strong><code>bind-interfaces</code></strong> 部分，原本的教學是啟用的，不過我這邊啟用的話會無法分享網絡，所以這邊用<code>#</code>註釋掉了</p>
</blockquote>

        <h3 id="設置-NAT"   >
          <a href="#設置-NAT" class="heading-link"><i class="fas fa-link"></i></a>設置 NAT</h3>
      <p>通過防火牆來設置 NAT</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables -t nat -A POSTROUTING -o wwan0 -j MASQUERADE  </span><br><span class="line">$ sudo iptables -A FORWARD -i wwan0 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT  </span><br><span class="line">$ sudo iptables -A FORWARD -i eth0 -o wwan0 -j ACCEPT</span><br></pre></td></tr></table></div></figure>

        <h4 id="設置為永久-NAT"   >
          <a href="#設置為永久-NAT" class="heading-link"><i class="fas fa-link"></i></a>設置為永久 NAT</h4>
      <p>保存設置</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo sh -c <span class="string">"iptables-save &gt; /etc/iptables.ipv4.nat"</span></span><br></pre></td></tr></table></div></figure>
<p>修改 <code>/etc/rc.local</code> 開機自動載入 NAT 設置</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Add this line above exit 0</span><br><span class="line">iptables-restore &lt; &#x2F;etc&#x2F;iptables.ipv4.nat</span><br></pre></td></tr></table></div></figure>

        <h2 id="完成"   >
          <a href="#完成" class="heading-link"><i class="fas fa-link"></i></a>完成</h2>
      <p>將手提電腦連上 Raspberry Pi 然後……可以了</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ping 8.8.8.8</span><br><span class="line">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=2 ttl=51 time=99.2 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=1 ttl=51 time=22.9 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=3 ttl=51 time=69.7 ms</span><br></pre></td></tr></table></div></figure>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/en/2020/Video-based-Motion-Detection-in-Python-with-OpenCV/">Video based Motion Detection in Python with OpenCV</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-04-11</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-04-12</span></span></div></header><div class="post-body"><div class="post-excerpt"><!-- # Video based Motion Detection in Python with OpenCV -->

        <h2 id="Demo"   >
          <a href="#Demo" class="heading-link"><i class="fas fa-link"></i></a>Demo</h2>
      <div class="video-container">
    <iframe width="560" height="315" src="https://www.youtube.com/embed/4cB2BpSVxBY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>

<p>I added 30 seconds buffer before start recording so we can see the green color indicates the detected movements.</p>

        <h2 id="What-you-need"   >
          <a href="#What-you-need" class="heading-link"><i class="fas fa-link"></i></a>What you need</h2>
      <ul>
<li>A Webcam</li>
<li>Python and pip</li>
</ul>

        <h3 id="Requirements-txt"   >
          <a href="#Requirements-txt" class="heading-link"><i class="fas fa-link"></i></a>Requirements.txt</h3>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opencv-python</span><br><span class="line">numpy</span><br></pre></td></tr></table></div></figure>

        <h2 id="Goal"   >
          <a href="#Goal" class="heading-link"><i class="fas fa-link"></i></a>Goal</h2>
      <p>To implement a security camera auto record videos when some thing moves in the view port.</p>

        <h3 id="Source-code"   >
          <a href="#Source-code" class="heading-link"><i class="fas fa-link"></i></a>Source code</h3>
      <p>The <span class="exturl"><a class="exturl__link"   href="https://github.com/RobinDavid/Motion-detection-OpenCV"  target="_blank" rel="noopener">original implementation</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> was in Python 2.x with OpenCV 3.x</p>
<p>I fork it to Python 3.x and make it compatible with OpenCV 4.x</p>
<blockquote>
<p>The <strong><code>MotionDetectorContours.py</code></strong> and <strong><code>MotionDetector.py</code></strong> results the same in the original implementation. But they give different result in my implementation, I guess it is because I skiped <strong><code>cv.Erode()</code></strong> in <strong><code>MotionDetectorContours.py</code></strong>.</p>
</blockquote>

        <h2 id="The-original-implementation"   >
          <a href="#The-original-implementation" class="heading-link"><i class="fas fa-link"></i></a>The original implementation</h2>
      <p>There are two implementation according to the developer.</p>

        <h3 id="Simple-way"   >
          <a href="#Simple-way" class="heading-link"><i class="fas fa-link"></i></a>Simple way</h3>
      <ol>
<li>Receive frames and send to process in <code>run()</code></li>
<li><code>processImage()</code> calculate difference of <strong>pixels</strong> in frames</li>
<li>If number of different pixels exceed the threshold, <code>somethingHasMoved()</code> return <code>True</code></li>
<li><code>run()</code> enable recording if <code>somethingHasMoved()</code> return <code>True</code></li>
</ol>

        <h3 id="Smart-way"   >
          <a href="#Smart-way" class="heading-link"><i class="fas fa-link"></i></a>Smart way</h3>
      <ol>
<li>Receive frames and send to process in <code>run()</code></li>
<li><code>processImage()</code> calculate difference of <strong>areas</strong> in frames with <code>cv2.findContours()</code></li>
<li>If change of area in comparing to total area exceed the threshold, <code>somethingHasMoved()</code> return <code>True</code></li>
<li><code>run()</code> enable recording if <code>somethingHasMoved()</code> return <code>True</code></li>
</ol>

        <h2 id="Our-implementation"   >
          <a href="#Our-implementation" class="heading-link"><i class="fas fa-link"></i></a>Our implementation</h2>
      <p>Our implementation will be based on <code>MotionDetectorContours.py</code>. It did better job for me and it can catch my eye blinking.</p>
<p>Import OpenCV for image processing, Numpy for replacing <code>cv2.CreateImage()</code>, datetime and tmie for showing video recording time.</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2 <span class="keyword">as</span> cv</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br></pre></td></tr></table></div></figure>
<p>Define a class for image processing and maintain the loop of reading frames.</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MotionDetectorAdaptative</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">onChange</span><span class="params">(self, val)</span>:</span> <span class="comment">#callback when the user change the detection threshold</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,threshold=<span class="number">25</span>, doRecord=True, showWindows=True)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initRecorder</span><span class="params">(self)</span>:</span> <span class="comment">#Create the recorder</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">processImage</span><span class="params">(self, curframe)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">somethingHasMoved</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></div></figure>
<p>The initializatoin:</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,threshold=<span class="number">25</span>, doRecord=True, showWindows=True)</span>:</span></span><br><span class="line">  self.writer = <span class="literal">None</span></span><br><span class="line">  self.font = <span class="literal">None</span></span><br><span class="line">  self.doRecord=doRecord <span class="comment">#Either or not record the moving object</span></span><br><span class="line">  self.show = showWindows <span class="comment">#Either or not show the 2 windows</span></span><br><span class="line">  self.frame = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">  self.capture=cv.VideoCapture(<span class="number">0</span>)</span><br><span class="line">  self.frame = self.capture.read()[<span class="number">1</span>] <span class="comment">#Take a frame to init recorder</span></span><br><span class="line">  <span class="keyword">if</span> doRecord:</span><br><span class="line">    self.initRecorder()</span><br><span class="line"></span><br><span class="line">  self.absdiff_frame = <span class="literal">None</span></span><br><span class="line">  self.previous_frame = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">  self.surface = self.frame.shape[<span class="number">0</span>] * self.frame.shape[<span class="number">1</span>]</span><br><span class="line">  self.currentsurface = <span class="number">0</span></span><br><span class="line">  self.currentcontours = <span class="literal">None</span></span><br><span class="line">  self.threshold = threshold</span><br><span class="line">  self.isRecording = <span class="literal">False</span></span><br><span class="line">  self.trigger_time = <span class="number">0</span> <span class="comment">#Hold timestamp of the last detection</span></span><br><span class="line">  self.es = cv.getStructuringElement(cv.MORPH_ELLIPSE, (<span class="number">9</span>,<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> showWindows:</span><br><span class="line">    cv.namedWindow(<span class="string">"Image"</span>)</span><br><span class="line">    <span class="comment"># for user to change threshold in runtime</span></span><br><span class="line">    cv.createTrackbar(<span class="string">"Detection treshold: "</span>, <span class="string">"Image"</span>, self.threshold, <span class="number">100</span>, self.onChange)</span><br></pre></td></tr></table></div></figure>
<p><code>run()</code> will maintain the loop to:</p>
<ol>
<li>read frame</li>
<li>pass to <code>processImage()</code></li>
<li>check if anything moved in <code>somethingHasMoved()</code>, <code>isRecording = True</code> if things moved</li>
<li>if <code>isRecording == True</code> a video recorder will be activated</li>
<li>draw area of moved/changed to frame and display it on screen</li>
<li>repeat the steps if <code>Esc</code> was not pressed</li>
</ol>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">  started = time.time()</span><br><span class="line">  <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">    currentframe = self.capture.read()[<span class="number">1</span>]</span><br><span class="line">    instant = time.time() <span class="comment">#Get timestamp o the frame</span></span><br><span class="line"></span><br><span class="line">    self.processImage(currentframe) <span class="comment">#Process the image</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.isRecording:</span><br><span class="line">      <span class="keyword">if</span> self.somethingHasMoved():</span><br><span class="line">        self.trigger_time = instant <span class="comment">#Update the trigger_time</span></span><br><span class="line">        <span class="keyword">if</span> instant &gt; started +<span class="number">10</span>:<span class="comment">#Wait 5 second after the webcam start for luminosity adjusting etc..</span></span><br><span class="line">          print(<span class="string">"Something is moving !"</span>)</span><br><span class="line">          <span class="keyword">if</span> self.doRecord: <span class="comment">#set isRecording=True only if we record a video</span></span><br><span class="line">            self.isRecording = <span class="literal">True</span></span><br><span class="line">      currentframe = cv.drawContours(currentframe, self.currentcontours, <span class="number">-1</span>, (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), cv.FILLED)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">if</span> instant &gt;= self.trigger_time +<span class="number">10</span>: <span class="comment">#Record during 10 seconds</span></span><br><span class="line">        print(<span class="string">"Stop recording"</span>)</span><br><span class="line">        self.isRecording = <span class="literal">False</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        cv.putText(currentframe,datetime.now().strftime(<span class="string">"%b %d, %H:%M:%S"</span>), (<span class="number">25</span>,<span class="number">30</span>),self.font, <span class="number">1</span>, (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">2</span>, cv.LINE_AA) <span class="comment">#Put date on the frame</span></span><br><span class="line">        self.writer.write(currentframe) <span class="comment">#Write the frame</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.show:</span><br><span class="line">      cv.imshow(<span class="string">"Image"</span>, currentframe)</span><br><span class="line"></span><br><span class="line">    c=cv.waitKey(<span class="number">1</span>) % <span class="number">0x100</span></span><br><span class="line">    <span class="keyword">if</span> c==<span class="number">27</span> <span class="keyword">or</span> c == <span class="number">10</span>: <span class="comment">#Break if user enters 'Esc'.</span></span><br><span class="line">      <span class="keyword">break</span></span><br></pre></td></tr></table></div></figure>
<p>Find the change between frames and do simple feature extraction, result saved to <code>self.gray_frame</code>.</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">processImage</span><span class="params">(self, curframe)</span>:</span></span><br><span class="line">    curframe = cv.GaussianBlur(curframe, (<span class="number">21</span>,<span class="number">21</span>), <span class="number">0</span>) <span class="comment">#Remove false positives</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.absdiff_frame <span class="keyword">is</span> <span class="literal">None</span>: <span class="comment">#For the first time put values in difference, temp and moving_average</span></span><br><span class="line">      self.absdiff_frame = curframe.copy()</span><br><span class="line">      self.previous_frame = curframe.copy()</span><br><span class="line">      self.average_frame = np.float32(curframe) <span class="comment">#Should convert because after runningavg take 32F pictures</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      cv.accumulateWeighted(curframe, self.average_frame, <span class="number">0.05</span>) <span class="comment">#Compute the average</span></span><br><span class="line"></span><br><span class="line">    self.previous_frame = self.average_frame.astype(np.uint8) <span class="comment">#Convert back to 8U frame</span></span><br><span class="line"></span><br><span class="line">    self.absdiff_frame = cv.absdiff(curframe, self.previous_frame) <span class="comment"># moving_average - curframe</span></span><br><span class="line"></span><br><span class="line">    self.gray_frame = cv.cvtColor(self.absdiff_frame, cv.COLOR_BGR2GRAY) <span class="comment">#Convert to gray otherwise can't do threshold</span></span><br><span class="line">    self.gray_frame = cv.threshold(self.gray_frame, <span class="number">5</span>, <span class="number">255</span>, cv.THRESH_BINARY)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    self.gray_frame = cv.dilate(self.gray_frame, self.es) <span class="comment">#to get object blobs</span></span><br><span class="line">    <span class="comment"># cv.Erode(self.gray_frame, self.gray_frame, None, 10)</span></span><br></pre></td></tr></table></div></figure>
<p>Find the area of changes and compare to threshold over the whole area:</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">somethingHasMoved</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Find contours, ignore other return values (image, contours, hierarchy)[1]</span></span><br><span class="line">  contours = cv.findContours(self.gray_frame, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  self.currentcontours = contours <span class="comment">#Save contours</span></span><br><span class="line"></span><br><span class="line">  self.currentsurface = sum([cv.contourArea(c) <span class="keyword">for</span> c <span class="keyword">in</span> contours]) <span class="comment">#For all contours compute the area</span></span><br><span class="line"></span><br><span class="line">  avg = (self.currentsurface*<span class="number">100</span>)/self.surface <span class="comment">#Calculate the average of contour area on the total size</span></span><br><span class="line">  self.currentsurface = <span class="number">0</span> <span class="comment">#Put back the current surface to 0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> avg &gt; self.threshold:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></div></figure>
<p>If user change threshold during runtime, <code>onChange()</code> method in the class will be triggered:</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">onChange</span><span class="params">(self, val)</span>:</span> <span class="comment">#callback when the user change the detection threshold</span></span><br><span class="line">  self.threshold = val</span><br></pre></td></tr></table></div></figure>
<p>Declare a video recorder writes frame to video file:</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initRecorder</span><span class="params">(self)</span>:</span> <span class="comment">#Create the recorder</span></span><br><span class="line">  codec = cv.VideoWriter_fourcc(<span class="string">'M'</span>, <span class="string">'J'</span>, <span class="string">'P'</span>, <span class="string">'G'</span>)</span><br><span class="line">  self.writer=cv.VideoWriter(datetime.now().strftime(<span class="string">"%b-%d_%H_%M_%S"</span>)+<span class="string">".wmv"</span>, codec, <span class="number">5</span>, self.frame.shape[<span class="number">1</span>::<span class="number">-1</span>], <span class="number">1</span>)</span><br><span class="line">  <span class="comment">#FPS set to 5 because it seems to be the fps of my cam but should be ajusted to your needs</span></span><br><span class="line">  self.font = cv.FONT_HERSHEY_SIMPLEX <span class="comment">#Creates a font</span></span><br></pre></td></tr></table></div></figure>
<p>Let’s try it.</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">  detect = MotionDetectorAdaptative(threshold=<span class="number">5</span>, doRecord=<span class="literal">True</span>)</span><br><span class="line">  detect.run()</span><br></pre></td></tr></table></div></figure>


        <h2 id="Improvements"   >
          <a href="#Improvements" class="heading-link"><i class="fas fa-link"></i></a>Improvements</h2>
      <p>There is a problem the video only record for 10 seconds. Base on <span class="exturl"><a class="exturl__link"   href="https://github.com/NewJerseyStyle/Motion-detection-OpenCV/blob/master/MotionDetectorContours.py"  target="_blank" rel="noopener">MotionDetectorContours.py</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> modify its condition to end recording:</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> instant &gt;= self.trigger_time +<span class="number">10</span> <span class="keyword">and</span> <span class="keyword">not</span> self.somethingHasMoved(): <span class="comment">#Record until move stop 10 seconds</span></span><br></pre></td></tr></table></div></figure>

<p>We can add an Email notification in this. You may refer to the tutorial sending <a href="/en/2020/Network-usage-monitor-using-Python/">Email notification for network usage report</a>. And we can then combine it with Raspberry Pi to build a security camera.</p>
<p>You will need these things for a Raspberry Pi security camera:</p>
<ul>
<li><span class="exturl"><a class="exturl__link"   href="https://www.raspberrypi.org/products/raspberry-pi-4-model-b/"  target="_blank" rel="noopener">Raspberry Pi</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://www.raspberrypi.org/products/camera-module-v2/"  target="_blank" rel="noopener">Raspberry Pi Camera Module V2</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://www.amazon.co.jp/10%E5%AF%BE%E5%BF%9C%E3%80%91Samsung-microSD%E3%82%AB%E3%83%BC%E3%83%8932GB-Nintendo-MB-MC32GA-ECO/dp/B06XSV23T1/ref=psdc_171386011_t3_B00J84T6HW"  target="_blank" rel="noopener">32 GB MicroSD Card</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
<blockquote>
<p>If you ask, I used a <span class="exturl"><a class="exturl__link"   href="https://www.amazon.co.jp/dp/B07VFFRX4C/ref=sspa_dk_detail_1?psc=1&pd_rd_i=B07VFFRX4C&pd_rd_w=uSbWD&pf_rd_p=6413bd85-d494-49e7-9f81-0e63e79171a9&pd_rd_wg=KjEEj&pf_rd_r=79C32JCV4SJVAGQEC7R6&pd_rd_r=0a132dab-0895-4d9f-aa14-439b4d6d1eeb&spLa=ZW5jcnlwdGVkUXVhbGlmaWVyPUEzNk1ZN1I1UkI3RDM4JmVuY3J5cHRlZElkPUEwODcxNjM4M0RGT1ZERlg4Nlo2UCZlbmNyeXB0ZWRBZElkPUEySU9FRjk0M1ZBWFQ1JndpZGdldE5hbWU9c3BfZGV0YWlsJmFjdGlvbj1jbGlja1JlZGlyZWN0JmRvTm90TG9nQ2xpY2s9dHJ1ZQ=="  target="_blank" rel="noopener">wide angle camera</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p>Sixfab has a tutorial about <span class="exturl"><a class="exturl__link"   href="https://sixfab.com/tutorial-7-raspberry-pi-security-system-with-sixfab-3glte-shields/"  target="_blank" rel="noopener">Raspberry Pi Security System with Sixfab 3G, 4G/LTE Base Shield</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>. It seem to use a motion sensor to detect moment in the area and activate camera when sensor detect movement, it then send a frame to a email specified in the Python script.</p>
<p>I didn’t find the hardware list of their design, but the <span class="exturl"><a class="exturl__link"   href="https://raw.githubusercontent.com/sixfab/Sixfab_RPi_3G-4G-LTE_Base_Shield/master/tutorials/tutorial7/SecuritySystem.py"  target="_blank" rel="noopener">Python source code is here</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>.</p>
<p>I think using a motion sensor is a good idea, <span class="exturl"><a class="exturl__link"   href="https://www.instructables.com/id/Docker-Pi-Series-of-Sensor-Hub-Board-About-IOT/"  target="_blank" rel="noopener">Docker Pi Series of Sensor Hub</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> seem to be a good option, considering to have it in my production environment.</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/zh-TW/2020/Raspberry-Pi-%E4%BD%BF%E7%94%A8-4G-%E6%95%B8%E6%93%9A%E7%B6%B2%E8%B7%AF/">Raspberry Pi 使用 4G 數據網路</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-04-11</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-04-19</span></span></div></header><div class="post-body"><div class="post-excerpt"><!-- # Raspberry Pi connect to 4G LTE -->

        <h2 id="購物清單"   >
          <a href="#購物清單" class="heading-link"><i class="fas fa-link"></i></a>購物清單</h2>
      <ul>
<li><span class="exturl"><a class="exturl__link"   href="https://www.raspberrypi.org/products/"  target="_blank" rel="noopener">Raspberry Pi</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>SD Card with <span class="exturl"><a class="exturl__link"   href="https://projects.raspberrypi.org/en/projects/raspberry-pi-setting-up"  target="_blank" rel="noopener">Linux installed</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://sixfab.com/product/raspberry-pi-base-hat-3g-4g-lte-minipcie-cards/"  target="_blank" rel="noopener">Raspberry Pi 3G/4G-LTE Base HAT</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://sixfab.com/product/quectel-ec25-mini-pcle-4glte-module/"  target="_blank" rel="noopener">Quectel EC25 Mini PCle 4G/LTE Module</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://sixfab.com/product/lte-main-diversity-gnss-triple-port-u-fl-antenna-100mm/"  target="_blank" rel="noopener">LTE Main &amp; Diversity &amp; GNSS Triple Port u.FL Antenna </a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
<blockquote>
<p>不想分開購買零件，可以<span class="exturl"><a class="exturl__link"   href="https://sixfab.com/product/raspberry-pi-4g-lte-modem-kit/"  target="_blank" rel="noopener">購買 Sixfab 的 Raspberry Pi 4G/LTE套件</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>

        <h2 id="組裝"   >
          <a href="#組裝" class="heading-link"><i class="fas fa-link"></i></a>組裝</h2>
      <ol>
<li><p>安裝 Mini PCIe 4G IoT Module 到 3G/4G-LTE Base HAT，感覺和以前在手提電腦上安裝記憶體差不多。</p>
</li>
<li><p>然後將 3G/4G-LTE Base HAT 裝上 Raspberry Pi。<br><img   src="https://sixfab-com.exactdn.com/wp-content/uploads/2019/09/Base_HAT_with_EC25A.jpg?strip=all&lossy=0&ssl=1" style=""  alt="Installed onto Pi" title=" After assembly Raspberry Pi @sixfab "><center><em>完成之後大概這樣的感覺（圖片來源：<span class="exturl"><a class="exturl__link"   href="https://sixfab.com/product/raspberry-pi-base-hat-3g-4g-lte-minipcie-cards/"  target="_blank" rel="noopener">@sixfab</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>）</em></center></p>
</li>
<li><p>將天線也安裝上去，正確地完成安裝之後的樣子大概這樣<br><img src="https://www.torbox.ch/wp-content/uploads/2019/12/IMG_5237-e1576357032325.jpg" alt="Connect Antenna" title=" Complete assembly @https://www.torbox.ch/?p=1165 "><center><em>加上天線應該這樣個樣子吧（圖片來源：<span class="exturl"><a class="exturl__link"   href="https://www.torbox.ch/?p=1165"  target="_blank" rel="noopener">@torbox.ch</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>）</em></center></p>
</li>
</ol>
<p>最左邊和最右邊的兩個天線似乎是可以互換的，我安裝完成之後那些線是平行的。</p>

        <h2 id="安裝驅動"   >
          <a href="#安裝驅動" class="heading-link"><i class="fas fa-link"></i></a>安裝驅動</h2>
      <p>Sixfab 提供了兩種方法驅動 LTE 模組，一個是 <span class="exturl"><a class="exturl__link"   href="https://sixfab.com/ppp-installer-for-sixfab-shield/"  target="_blank" rel="noopener">PPP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 一個是 <span class="exturl"><a class="exturl__link"   href="https://sixfab.com/qmi-interface-with-3g-4g-lte-base-shield-v2/"  target="_blank" rel="noopener">QMI interface</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。這邊我用的是 PPP。</p>
<p>在 Raspberry Pi 的終端模擬器裡進行操作，下載 sixfab 的安裝腳本，然後跟著指引進行安裝就可以了。簡單方便快捷，感謝sixfab。</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://raw.githubusercontent.com/sixfab/Sixfab_PPP_Installer/master/ppp_installer/install.sh</span><br><span class="line"></span><br><span class="line">$ chmod +x install.sh</span><br><span class="line"></span><br><span class="line">$ sudo ./install.sh</span><br></pre></td></tr></table></div></figure>


        <h3 id="有些選項可能比較曖昧，給個避坑指南"   >
          <a href="#有些選項可能比較曖昧，給個避坑指南" class="heading-link"><i class="fas fa-link"></i></a>有些選項可能比較曖昧，給個避坑指南</h3>
      <ul>
<li>Choose your Sixfab<ul>
<li>因為買的是 <code>3G, 4G/LTE Base Shield</code> 所以只填 <code>2</code></li>
<li>就算之後連不上也肯定不是這裡填錯</li>
</ul>
</li>
<li>APN<ul>
<li>問問谷歌、雅虎或者百度你這家電信商的基地台用什麼存取點名稱（APN），選一個填，不對之後再改</li>
<li>將你的 SIM 卡插入智能電話，看看設定裡行動網絡設定關於存取點名稱裡有什麼選項，選一個填，不對之後再改</li>
<li>之後修改的方法參見出坑指南</li>
</ul>
</li>
<li>PORT name<ul>
<li>因為買的是 <code>3G, 4G/LTE Base Shield</code> 所以只填 <code>ttyUSB3</code></li>
<li>肯定是 <code>ttyUSB3</code>，跟實際上你硬件上插哪個 USB 位置好像沒關係，可能是用的 GPIO？</li>
</ul>
</li>
</ul>

        <h2 id="沒能避開坑？出坑指南"   >
          <a href="#沒能避開坑？出坑指南" class="heading-link"><i class="fas fa-link"></i></a>沒能避開坑？出坑指南</h2>
      
        <h3 id="我需要登入才能上網"   >
          <a href="#我需要登入才能上網" class="heading-link"><i class="fas fa-link"></i></a>我需要登入才能上網</h3>
      <p>如果你需要用戶名和密碼登入才能上網，完成前面的安裝和設定之後再編輯 <code>/etc/ppp/peers/provider</code> 檔案。</p>
<p>你要移除這一行</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noauth</span><br></pre></td></tr></table></div></figure>
<p>然後按照以下格式填入登錄資料</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user &quot;YOUR USERNAME&quot;</span><br><span class="line">password &quot;YOURPASSWORD&quot;</span><br></pre></td></tr></table></div></figure>

        <h3 id="遇到-Routing-error-的錯誤"   >
          <a href="#遇到-Routing-error-的錯誤" class="heading-link"><i class="fas fa-link"></i></a>遇到 Routing error 的錯誤</h3>
      <p>執行以下指令</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo route del default</span><br><span class="line"></span><br><span class="line">$ sudo route add default ppp0</span><br></pre></td></tr></table></div></figure>

        <h3 id="沒有網絡連接"   >
          <a href="#沒有網絡連接" class="heading-link"><i class="fas fa-link"></i></a>沒有網絡連接</h3>
      <p>誰也 ping 不到，網絡不通，或者無盡的連接超時</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ping 8.8.8.8</span><br><span class="line">connect: network is unreachable </span><br><span class="line">$ ping baidu.com</span><br><span class="line">connect: network is unreachable </span><br><span class="line">`</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>檢查你的移動數據是否需要先在手機上啟用</p>
</blockquote>
<p>試試手動連接移動數據</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pon</span><br></pre></td></tr></table></div></figure>
<p>你可能發現 Modem hang up 並且不論你做什麼都沒有什麼效果。</p>
<p>我已經坑過幾次了，基本上問題就是 APN 填錯了，或者舊的 APN 已經不能用了。於是我將 SIM 插入手機，看手機自動連上網絡的時候用的哪個 APN 再修改 <code>/etc/ppp/peers/provider</code> 文件</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo poff</span><br><span class="line">$ sudo nano /etc/ppp/peers/provider</span><br></pre></td></tr></table></div></figure>
<p>APN 在我 <code>/etc/ppp/peers/provider</code> 文件裡第三行的結尾。</p>
<p>逐一測試你所能找到的 APN，看看 <code>sudo pon</code> 能不能連上，應該其中一個能連上。至少我是成功了。</p>

        <h2 id="DONE"   >
          <a href="#DONE" class="heading-link"><i class="fas fa-link"></i></a>DONE</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ping 8.8.8.8</span><br><span class="line">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=1 ttl=52 time=20.9 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=2 ttl=52 time=111 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=3 ttl=52 time=69.7 ms</span><br></pre></td></tr></table></div></figure>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/en/2020/Network-usage-monitor-using-Python/">Network usage monitor using Python</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-04-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-04-10</span></span></div></header><div class="post-body"><div class="post-excerpt"><!-- # Network usage monitor using Python -->

        <h2 id="Previous"   >
          <a href="#Previous" class="heading-link"><i class="fas fa-link"></i></a>Previous</h2>
      <p>We have <a href="/en/2020/Raspberry-Pi-as-4G-LTE-Router/">built a 4G/LTE router</a> but how do I know its network usage? How much will it cost me?</p>

        <h2 id="Goal"   >
          <a href="#Goal" class="heading-link"><i class="fas fa-link"></i></a>Goal</h2>
      <p>We are now going to write a Python script to send Email notificatoin for network usage and set a threshold for it.</p>
<blockquote>
<p>I assume you know the basic pattern how to code in Python</p>
</blockquote>

        <h2 id="Requirements-txt"   >
          <a href="#Requirements-txt" class="heading-link"><i class="fas fa-link"></i></a>Requirements.txt</h2>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">psutil</span><br><span class="line">python_http_client</span><br><span class="line">sendgrid</span><br></pre></td></tr></table></div></figure>

<p>You can install them by typing in terminal:</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip3 install psutil python_http_client sendgrid</span><br></pre></td></tr></table></div></figure>

<blockquote>
<p>You may need to specify <strong><code>pip3</code></strong> in Raspbian as both Python 2.x and Python 3.x were installed.</p>
</blockquote>

        <h2 id="Coding-Python"   >
          <a href="#Coding-Python" class="heading-link"><i class="fas fa-link"></i></a>Coding Python</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir network-monitor</span><br><span class="line">$ <span class="built_in">cd</span> network-monitor</span><br><span class="line">$ nano monitor.py</span><br></pre></td></tr></table></div></figure>
<p>And then we start coding</p>

        <h3 id="Get-network-usage"   >
          <a href="#Get-network-usage" class="heading-link"><i class="fas fa-link"></i></a>Get network usage</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"></span><br><span class="line">NETWORK_INTERFACE = <span class="string">'ppp0'</span></span><br><span class="line"></span><br><span class="line">netio = psutil.net_io_counters(pernic=<span class="literal">True</span>)</span><br><span class="line">net_usage = netio[NETWORK_INTERFACE].bytes_sent + netio[NETWORK_INTERFACE].bytes_recv</span><br><span class="line"></span><br><span class="line">print(net_usage, <span class="string">"bytes"</span>)</span><br></pre></td></tr></table></div></figure>
<p>It will show you how many bytes it has transfered for upload and download.</p>
<blockquote>
<p>If it shows zero, change <strong><code>NETWORK_INTERFACE</code></strong> to <strong><code>wwan0</code></strong>.</p>
</blockquote>

        <h3 id="Set-threshold"   >
          <a href="#Set-threshold" class="heading-link"><i class="fas fa-link"></i></a>Set threshold</h3>
      <figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"></span><br><span class="line">NETWORK_INTERFACE = <span class="string">'wwan0'</span></span><br><span class="line">NETWORK_LIMIT = <span class="number">5000000</span> <span class="comment"># 5GB in SI standard</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  netio = psutil.net_io_counters(pernic=<span class="literal">True</span>)</span><br><span class="line">  net_usage = netio[NETWORK_INTERFACE].bytes_sent + netio[NETWORK_INTERFACE].bytes_recv</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> net_usage &gt; NETWORK_LIMIT:</span><br><span class="line">    print(<span class="string">"Meets network limit!"</span>)</span><br><span class="line"></span><br><span class="line">    print(net_usage, <span class="string">"bytes has been used"</span>)</span><br></pre></td></tr></table></div></figure>
<p>Once it over the <code>NETWORK_LIMIT</code> it will print a lot of lines of “Meets network limit!”. We can add a timer to check the network limit every X second.</p>

        <h3 id="Separate-the-config-and-code"   >
          <a href="#Separate-the-config-and-code" class="heading-link"><i class="fas fa-link"></i></a>Separate the config and code</h3>
      <p>Try to separate the cnofiguratoin and the Python script so we can reuse this project on other devices.</p>
<p><code>configparser</code> is really a good helper on this.</p>
<p>Create a file <code>monitor.conf</code></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Email]</span><br><span class="line">SENDGRID_API_KEY &#x3D; Your.Keyfrom_SendGrid</span><br><span class="line">from &#x3D; helper@raspberry.pi</span><br><span class="line">to &#x3D; your@email.address</span><br><span class="line">subject &#x3D; From your Raspberry Pi</span><br><span class="line"></span><br><span class="line">[Network]</span><br><span class="line">INTERFACE &#x3D; wwan0</span><br><span class="line">LIMIT &#x3D; 45000000000</span><br><span class="line"></span><br><span class="line">[Misc]</span><br><span class="line">TIME_INTER &#x3D; 36</span><br></pre></td></tr></table></div></figure>

<p>Now we can load the configuration in Python</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line">config = configparser.ConfigParser()</span><br><span class="line">config.optionxform = str  <span class="comment">#reference: http://docs.python.org/library/configparser.html</span></span><br><span class="line">config.read(<span class="string">'monitor.conf'</span>)</span><br><span class="line"></span><br><span class="line">NETWORK_INTERFACE = config.get(<span class="string">'Network'</span>, <span class="string">'INTERFACE'</span>)		<span class="comment"># Define interface to check</span></span><br><span class="line">NETWORK_LIMIT = int(config.get(<span class="string">'Network'</span>, <span class="string">'LIMIT'</span>))			<span class="comment"># Define network limit</span></span><br><span class="line">SENDGRID_API_KEY = config.get(<span class="string">'Email'</span>, <span class="string">'SENDGRID_API_KEY'</span>)	<span class="comment"># Define the API key for SendGrid</span></span><br><span class="line">TIME_INTER = config.get(<span class="string">'Misc'</span>, <span class="string">'TIME_INTER'</span>)				<span class="comment"># Define time interval 36 seconds</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  time.sleep(TIME_INTER) <span class="comment"># Check every 36 seconds</span></span><br><span class="line">  netio = psutil.net_io_counters(pernic=<span class="literal">True</span>)</span><br><span class="line">  net_usage = netio[NETWORK_INTERFACE].bytes_sent + netio[NETWORK_INTERFACE].bytes_recv</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> net_usage &gt; NETWORK_LIMIT:</span><br><span class="line">    print(<span class="string">"Meets network limit!"</span>)</span><br><span class="line"></span><br><span class="line">    print(net_usage, <span class="string">"bytes has been used"</span>)</span><br></pre></td></tr></table></div></figure>


        <h3 id="Prepare-for-the-Email"   >
          <a href="#Prepare-for-the-Email" class="heading-link"><i class="fas fa-link"></i></a>Prepare for the Email</h3>
      <p>We use SendGrid to send the Email notification in this tutorial.</p>
<blockquote>
<p>You may need to sign up on SendGrid. I choose it because of 100 free email quota every day.</p>
</blockquote>

        <h4 id="Generate-SendGrid-API-Key"   >
          <a href="#Generate-SendGrid-API-Key" class="heading-link"><i class="fas fa-link"></i></a>Generate SendGrid API Key</h4>
      <p>The option is in <strong>Setting -&gt; API Keys -&gt; Create API Key</strong> <span class="exturl"><a class="exturl__link"   href="https://sendgrid.com/docs/ui/account-and-settings/api-keys/#creating-an-api-key"  target="_blank" rel="noopener">Creating an API key</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h4 id="Copy-the-Key-and-paste-to-monitor-conf"   >
          <a href="#Copy-the-Key-and-paste-to-monitor-conf" class="heading-link"><i class="fas fa-link"></i></a>Copy the Key and paste to monitor.conf</h4>
      <figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Email]</span><br><span class="line">SENDGRID_API_KEY &#x3D; Your.Keyfrom_SendGrid</span><br></pre></td></tr></table></div></figure>


        <h3 id="Write-python-script"   >
          <a href="#Write-python-script" class="heading-link"><i class="fas fa-link"></i></a>Write python script</h3>
      <p>Refer to their official guide <span class="exturl"><a class="exturl__link"   href="https://github.com/sendgrid/sendgrid-python"  target="_blank" rel="noopener">SendGrid GitHub repo</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">import</span> sendgrid</span><br><span class="line"><span class="keyword">from</span> sendgrid.helpers.mail <span class="keyword">import</span> *</span><br></pre></td></tr></table></div></figure>
<p>Read the <code>monitor.conf</code></p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line">config = configparser.ConfigParser()</span><br><span class="line">config.optionxform = str  <span class="comment">#reference: http://docs.python.org/library/configparser.html</span></span><br><span class="line">config.read(<span class="string">'netio-mon.conf'</span>)</span><br><span class="line"></span><br><span class="line">NETWORK_INTERFACE = config.get(<span class="string">'Network'</span>, <span class="string">'INTERFACE'</span>)</span><br><span class="line">NETWORK_LIMIT = int(config.get(<span class="string">'Network'</span>, <span class="string">'LIMIT'</span>))</span><br><span class="line">NETWORK_MAX = int(config.get(<span class="string">'Network'</span>, <span class="string">'MAX'</span>))</span><br><span class="line">SENDGRID_API_KEY = config.get(<span class="string">'Email'</span>, <span class="string">'SENDGRID_API_KEY'</span>)</span><br><span class="line">TIME_INTER = config.get(<span class="string">'Misc'</span>, <span class="string">'TIME_INTER'</span>)</span><br></pre></td></tr></table></div></figure>
<p>I would like to have some loggings too so I added this line</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">loggingFile = logging.FileHandler(<span class="string">'my.log'</span>, <span class="string">'w'</span>, <span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.DEBUG,</span><br><span class="line">        format=<span class="string">'%(asctime)s %(levelname)s %(message)s'</span>,</span><br><span class="line">        datefmt=<span class="string">'%Y-%m-%d %H:%M'</span>,</span><br><span class="line">        handlers=[loggingFile, ])</span><br></pre></td></tr></table></div></figure>
<p>Declare two methods for sending Email</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_message</span><span class="params">(sender, to, subject, message_text)</span>:</span></span><br><span class="line">  logging.info(<span class="string">"send email::"</span> + message_text)</span><br><span class="line">  from_email = Email(sender)</span><br><span class="line">  to_email = To(to)</span><br><span class="line">  subject = subject</span><br><span class="line">  content = Content(<span class="string">"text/plain"</span>, message_text)</span><br><span class="line">  <span class="keyword">return</span> Mail(from_email, to_email, subject, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_message</span><span class="params">(service, message)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> service.client.mail.send.post(request_body=message.get())</span><br></pre></td></tr></table></div></figure>
<p>Now the mean loop to check the network usage periodically.</p>
<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initialize the SendGrid API</span></span><br><span class="line">service = sendgrid.SendGridAPIClient(api_key=SENDGRID_API_KEY)</span><br><span class="line"></span><br><span class="line"><span class="comment"># A flag to make sure only send one notification</span></span><br><span class="line">have_sent = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  time.sleep(TIME_INTER)</span><br><span class="line">  netio = psutil.net_io_counters(pernic=<span class="literal">True</span>)</span><br><span class="line">  net_usage = netio[NETWORK_INTERFACE].bytes_sent + netio[NETWORK_INTERFACE].bytes_recv</span><br><span class="line">  <span class="keyword">if</span> net_usage &gt; NETWORK_LIMIT <span class="keyword">and</span> <span class="keyword">not</span> have_sent:</span><br><span class="line">    message = create_message(</span><br><span class="line">      config.get(<span class="string">'Email'</span>, <span class="string">'from'</span>),</span><br><span class="line">      config.get(<span class="string">'Email'</span>, <span class="string">'to'</span>),</span><br><span class="line">      config.get(<span class="string">'Email'</span>, <span class="string">'subject'</span>),</span><br><span class="line">      <span class="string">'The network have used %s bytes'</span> %net_usage)</span><br><span class="line">    send_message(service, message)</span><br><span class="line">    have_sent = <span class="literal">True</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="Improvement"   >
          <a href="#Improvement" class="heading-link"><i class="fas fa-link"></i></a>Improvement</h2>
      <ul>
<li>Prevent network usage lost, save the usage in the last email with <code>pickle</code></li>
<li>In order to monitoring network usage continuously, set one more <code>NETWORK_MAX</code> for reseting the flag after first email notification<br>See my <span class="exturl"><a class="exturl__link"   href="https://github.com/NewJerseyStyle/network-monitor"  target="_blank" rel="noopener">GitHub Repo</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/en/2020/Raspberry-Pi-connect-to-4G-LTE/">Raspberry Pi connect to 4G LTE</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-04-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-04-11</span></span></div></header><div class="post-body"><div class="post-excerpt"><!-- # Raspberry Pi connect to 4G LTE -->

        <h2 id="What-you-need"   >
          <a href="#What-you-need" class="heading-link"><i class="fas fa-link"></i></a>What you need</h2>
      <ul>
<li><span class="exturl"><a class="exturl__link"   href="https://www.raspberrypi.org/products/"  target="_blank" rel="noopener">Raspberry Pi</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>SD Card with <span class="exturl"><a class="exturl__link"   href="https://projects.raspberrypi.org/en/projects/raspberry-pi-setting-up"  target="_blank" rel="noopener">Linux installed</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://sixfab.com/product/raspberry-pi-base-hat-3g-4g-lte-minipcie-cards/"  target="_blank" rel="noopener">Raspberry Pi 3G/4G-LTE Base HAT</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://sixfab.com/product/quectel-ec25-mini-pcle-4glte-module/"  target="_blank" rel="noopener">Quectel EC25 Mini PCle 4G/LTE Module</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link"   href="https://sixfab.com/product/lte-main-diversity-gnss-triple-port-u-fl-antenna-100mm/"  target="_blank" rel="noopener">LTE Main &amp; Diversity &amp; GNSS Triple Port u.FL Antenna </a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
<blockquote>
<p>Alternative option: <span class="exturl"><a class="exturl__link"   href="https://sixfab.com/product/raspberry-pi-4g-lte-modem-kit/"  target="_blank" rel="noopener">Raspberry Pi 4G/LTE HAT Kit from Sixfab</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>

        <h2 id="Assembly"   >
          <a href="#Assembly" class="heading-link"><i class="fas fa-link"></i></a>Assembly</h2>
      <ol>
<li><p>Install Mini PCIe 4G IoT Module on Raspberry Pi 3G/4G-LTE Base HAT, it is similar to installing RAM modules in laptop.</p>
</li>
<li><p>Install Raspberry Pi 3G/4G-LTE Base HAT on Raspberry, it is simple.<br><img   src="https://sixfab-com.exactdn.com/wp-content/uploads/2019/09/Base_HAT_with_EC25A.jpg?strip=all&lossy=0&ssl=1" style=""  alt="Installed onto Pi" title=" After assembly Raspberry Pi @sixfab "><center><em>After assembly Raspberry Pi <span class="exturl"><a class="exturl__link"   href="https://sixfab.com/product/raspberry-pi-base-hat-3g-4g-lte-minipcie-cards/"  target="_blank" rel="noopener">@sixfab</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></em></center></p>
</li>
<li><p>Connect the Antenna to the Raspberry Pi 3G/4G-LTE Base HAT, the wire should be parallel if you connect them to right port.<br><img src="https://www.torbox.ch/wp-content/uploads/2019/12/IMG_5237-e1576357032325.jpg" alt="Connect Antenna" title=" Complete assembly @https://www.torbox.ch/?p=1165 "><center><em>Complete assembly <span class="exturl"><a class="exturl__link"   href="https://www.torbox.ch/?p=1165"  target="_blank" rel="noopener">@torbox.ch</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></em></center></p>
</li>
</ol>
<p>The function of two outermost cable seem to be identical, all Antenna cables are parallel in my assembly and it works well.</p>

        <h2 id="Driver"   >
          <a href="#Driver" class="heading-link"><i class="fas fa-link"></i></a>Driver</h2>
      <p>Sixfab provides two methods to control the LTE module, <span class="exturl"><a class="exturl__link"   href="https://sixfab.com/ppp-installer-for-sixfab-shield/"  target="_blank" rel="noopener">PPP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> and <span class="exturl"><a class="exturl__link"   href="https://sixfab.com/qmi-interface-with-3g-4g-lte-base-shield-v2/"  target="_blank" rel="noopener">QMI interface</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>.</p>
<p>I used PPP connection here.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://raw.githubusercontent.com/sixfab/Sixfab_PPP_Installer/master/ppp_installer/install.sh</span><br><span class="line"></span><br><span class="line">$ chmod +x install.sh</span><br><span class="line"></span><br><span class="line">$ sudo ./install.sh</span><br></pre></td></tr></table></div></figure>


        <h3 id="Few-options-confused-me-and-here-are-tips"   >
          <a href="#Few-options-confused-me-and-here-are-tips" class="heading-link"><i class="fas fa-link"></i></a>Few options confused me and here are tips:</h3>
      <ul>
<li>Choose your Sixfab<ul>
<li>Always <code>2</code> for the <code>3G, 4G/LTE Base Shield</code></li>
</ul>
</li>
<li>APN<ul>
<li>Google the APN for the service provider</li>
<li>Or insert the SIM Card to a phone and view the APN in settings</li>
</ul>
</li>
<li>PORT name<ul>
<li>For 3G, 4G/LTE Base Shield &amp;&amp; Base HAT it will be <code>ttyUSB3</code></li>
<li>Always <code>ttyUSB3</code>, no thing to do with physical port</li>
</ul>
</li>
</ul>

        <h2 id="Troubleshooting"   >
          <a href="#Troubleshooting" class="heading-link"><i class="fas fa-link"></i></a>Troubleshooting</h2>
      
        <h3 id="Need-auth-option-in-setup"   >
          <a href="#Need-auth-option-in-setup" class="heading-link"><i class="fas fa-link"></i></a>Need auth option in setup</h3>
      <p>If your service provider need username/password to use the network, edit <code>/etc/ppp/peers/provider</code> later to add your username and password.<br>Remove line</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noauth</span><br></pre></td></tr></table></div></figure>
<p>And add two lines</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user &quot;YOUR USERNAME&quot;</span><br><span class="line">password &quot;YOURPASSWORD&quot;</span><br></pre></td></tr></table></div></figure>

        <h3 id="Routing-error"   >
          <a href="#Routing-error" class="heading-link"><i class="fas fa-link"></i></a>Routing error</h3>
      <p>In this case, run the following commands</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo route del default</span><br><span class="line"></span><br><span class="line">$ sudo route add default ppp0</span><br></pre></td></tr></table></div></figure>

        <h3 id="No-network"   >
          <a href="#No-network" class="heading-link"><i class="fas fa-link"></i></a>No network</h3>
      <p>Try manually connect to cellular network:</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pon</span><br></pre></td></tr></table></div></figure>
<p>Modem hang up and you tried all solution, nothing work and do not know why</p>
<p>I have encountered few time on this problem, it hang up while connecting to network.<br>Because of incorrect APN, try all APN you can find on network and in your phone’s setting. To change the APN, edit <code>/etc/ppp/peers/provider</code></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo poff</span><br><span class="line">$ sudo nano /etc/ppp/peers/provider</span><br></pre></td></tr></table></div></figure>
<p>The APN is on the end of the 3rd line in my <code>/etc/ppp/peers/provider</code>.</p>
<p>Try every APN you can find for the service provider try connect with <code>sudo pon</code> and one of them should work.</p>

        <h2 id="DONE"   >
          <a href="#DONE" class="heading-link"><i class="fas fa-link"></i></a>DONE</h2>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ping 8.8.8.8</span><br><span class="line">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=1 ttl=52 time=20.9 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=2 ttl=52 time=111 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=3 ttl=52 time=69.7 ms</span><br></pre></td></tr></table></div></figure>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/en/2020/Raspberry-Pi-as-4G-LTE-Router/">Raspberry Pi as 4G LTE Router</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-04-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-04-11</span></span></div></header><div class="post-body"><div class="post-excerpt"><!-- # Raspberry Pi as 4G LTE Router -->

        <h2 id="Previous"   >
          <a href="#Previous" class="heading-link"><i class="fas fa-link"></i></a>Previous</h2>
      <p>We have <a href="/en/2020/Raspberry-Pi-connect-to-4G-LTE/">established connection to 4G LTE network</a></p>

        <h2 id="Goal"   >
          <a href="#Goal" class="heading-link"><i class="fas fa-link"></i></a>Goal</h2>
      <p>We are going to turn the Raspberry Pi into a Router for our devices, pick your need:</p>
<ul>
<li><a href="#Wireless-Router">Goto Wireless router section</a></li>
<li><a href="#Wired-Router">Goto Wired router section</a></li>
</ul>

        <h2 id="Wireless-Router"   >
          <a href="#Wireless-Router" class="heading-link"><i class="fas fa-link"></i></a>Wireless Router</h2>
      <p>Instead of reinventing the wheel, we follow the guide <span class="exturl"><a class="exturl__link"   href="https://sixfab.com/using-sixfab-raspberry-p-shield-hat-as-a-wi-fi-hotspot-access-point/"  target="_blank" rel="noopener">Sixfab tutorial</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>If you are using Raspberry Pi 2 or earlier, you will need a USB WiFi adaptor.</p>

        <h3 id="Backup-wireless-configurations"   >
          <a href="#Backup-wireless-configurations" class="heading-link"><i class="fas fa-link"></i></a>Backup wireless configurations</h3>
      <p>Not a must but you may want to do this, in case later you changed your mind.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp /etc/wpa_supplicant/wpa_supplicant.conf /etc/wpa_supplicant/wpa_supplicant.backup.conf</span><br></pre></td></tr></table></div></figure>


        <h3 id="Configure-wireless-device"   >
          <a href="#Configure-wireless-device" class="heading-link"><i class="fas fa-link"></i></a>Configure wireless device</h3>
      <p>Clear the configuration file</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp /dev/null /etc/wpa_supplicant/wpa_supplicant.conf</span><br></pre></td></tr></table></div></figure>
<p>Add configurations into <code>/etc/wpa_supplicant/wpa_supplicant.conf</code>:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctrl_interface&#x3D;DIR&#x3D;&#x2F;var&#x2F;run&#x2F;wpa_supplicant GROUP&#x3D;netdev</span><br><span class="line">update_config&#x3D;1</span><br></pre></td></tr></table></div></figure>


        <h3 id="Install-RaspAP"   >
          <a href="#Install-RaspAP" class="heading-link"><i class="fas fa-link"></i></a>Install RaspAP</h3>
      <p>Use a quick installer of <span class="exturl"><a class="exturl__link"   href="https://github.com/billz/raspap-webgui"  target="_blank" rel="noopener">RaspAP</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> and follow the questions to setup the wireless network</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -q https://git.io/voEUQ -O /tmp/raspap &amp;&amp; bash /tmp/raspap -y</span><br></pre></td></tr></table></div></figure>
<p>I did not tested this, so any problem or question (default password etc.), please refer to the <span class="exturl"><a class="exturl__link"   href="https://sixfab.com/using-sixfab-raspberry-p-shield-hat-as-a-wi-fi-hotspot-access-point/"  target="_blank" rel="noopener">Sixfab tutorial</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> and the toubleshooting in the <span class="exturl"><a class="exturl__link"   href="https://howtoraspberrypi.com/create-a-wi-fi-hotspot-in-less-than-10-minutes-with-pi-raspberry/"  target="_blank" rel="noopener">original tutorial</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="Wired-Router"   >
          <a href="#Wired-Router" class="heading-link"><i class="fas fa-link"></i></a>Wired Router</h2>
      <p>We are going to use network address translation (NAT) to bridge <code>ppp0</code> with <code>eth0</code></p>
<p>This tutorial was adopting <span class="exturl"><a class="exturl__link"   href="https://raspberrypi.stackexchange.com/questions/48307/sharing-the-pis-wifi-connection-through-the-ethernet-port"  target="_blank" rel="noopener">sharing wifi through the ethernet</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> and change it to share PPP connection to ethernet</p>

        <h3 id="DHCP-and-DNS-server"   >
          <a href="#DHCP-and-DNS-server" class="heading-link"><i class="fas fa-link"></i></a>DHCP and DNS server</h3>
      <p>I used <code>dnsmasq</code> for DHCP + DNS.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install dnsmasq</span><br></pre></td></tr></table></div></figure>

        <h3 id="Configurate-interfaces"   >
          <a href="#Configurate-interfaces" class="heading-link"><i class="fas fa-link"></i></a>Configurate interfaces</h3>
      <p>Edit the <code>eth0</code> section in file <code>/etc/network/interfaces</code>:</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">allow-hotplug eth0  </span><br><span class="line">iface eth0 inet static  </span><br><span class="line">    address 192.168.2.1</span><br><span class="line">    netmask 255.255.255.0</span><br><span class="line">    network 192.168.2.0</span><br><span class="line">    broadcast 192.168.2.255</span><br></pre></td></tr></table></div></figure>

        <h3 id="Configure-dnsmasq"   >
          <a href="#Configure-dnsmasq" class="heading-link"><i class="fas fa-link"></i></a>Configure dnsmasq</h3>
      <p>Backup dnsmasq configuration</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig</span><br></pre></td></tr></table></div></figure>
<p>Edit <code>/etc/dnsmasq.conf</code></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">interface&#x3D;eth0      # Use interface eth0  </span><br><span class="line">listen-address&#x3D;192.168.2.1 # listen on  </span><br><span class="line"># Bind to the interface to make sure we aren&#39;t sending things elsewhere  </span><br><span class="line">#### bind-interfaces #### BUT don&#39;t enable this.</span><br><span class="line">server&#x3D;8.8.8.8       # Forward DNS requests to Google DNS  </span><br><span class="line">domain-needed        # Don&#39;t forward short names  </span><br><span class="line"># Never forward addresses in the non-routed address spaces.</span><br><span class="line">bogus-priv</span><br><span class="line"># Assign IP addresses between 192.168.2.2 and 192.168.2.100 with a</span><br><span class="line"># 12 hour lease time</span><br><span class="line">dhcp-range&#x3D;192.168.2.2,192.168.2.100,12h</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>Enable <strong><code>bind-interfaces</code></strong> cause me unable to share the internet. You may need to test it.</p>
</blockquote>

        <h3 id="NAT-configuration"   >
          <a href="#NAT-configuration" class="heading-link"><i class="fas fa-link"></i></a>NAT configuration</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables -t nat -A POSTROUTING -o wwan0 -j MASQUERADE  </span><br><span class="line">$ sudo iptables -A FORWARD -i wwan0 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT  </span><br><span class="line">$ sudo iptables -A FORWARD -i eth0 -o wwan0 -j ACCEPT</span><br></pre></td></tr></table></div></figure>
<p>Make the rules persistent.</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo sh -c <span class="string">"iptables-save &gt; /etc/iptables.ipv4.nat"</span></span><br></pre></td></tr></table></div></figure>
<p>Edit <code>/etc/rc.local</code></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Add this line above exit 0</span><br><span class="line">iptables-restore &lt; &#x2F;etc&#x2F;iptables.ipv4.nat</span><br></pre></td></tr></table></div></figure>

        <h2 id="DONE"   >
          <a href="#DONE" class="heading-link"><i class="fas fa-link"></i></a>DONE</h2>
      <p>Connect my laptop to Raspberry Pi </p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ping 8.8.8.8</span><br><span class="line">PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=2 ttl=51 time=99.2 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=1 ttl=51 time=22.9 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=3 ttl=51 time=69.7 ms</span><br></pre></td></tr></table></div></figure>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/en/2020/hello-world/">Hello World</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-04-05</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-04-05</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>Welcome to <span class="exturl"><a class="exturl__link"   href="https://hexo.io/"  target="_blank" rel="noopener">Hexo</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>! This is your very first post. Check <span class="exturl"><a class="exturl__link"   href="https://hexo.io/docs/"  target="_blank" rel="noopener">documentation</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> for more info. If you get any problems when using Hexo, you can find the answer in <span class="exturl"><a class="exturl__link"   href="https://hexo.io/docs/troubleshooting.html"  target="_blank" rel="noopener">troubleshooting</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> or you can ask me on <span class="exturl"><a class="exturl__link"   href="https://github.com/hexojs/hexo/issues"  target="_blank" rel="noopener">GitHub</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>.</p>

        <h2 id="Quick-Start"   >
          <a href="#Quick-Start" class="heading-link"><i class="fas fa-link"></i></a>Quick Start</h2>
      
        <h3 id="Create-a-new-post"   >
          <a href="#Create-a-new-post" class="heading-link"><i class="fas fa-link"></i></a>Create a new post</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></div></figure>

<p>More info: <span class="exturl"><a class="exturl__link"   href="https://hexo.io/docs/writing.html"  target="_blank" rel="noopener">Writing</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="Run-server"   >
          <a href="#Run-server" class="heading-link"><i class="fas fa-link"></i></a>Run server</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></div></figure>

<p>More info: <span class="exturl"><a class="exturl__link"   href="https://hexo.io/docs/server.html"  target="_blank" rel="noopener">Server</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="Generate-static-files"   >
          <a href="#Generate-static-files" class="heading-link"><i class="fas fa-link"></i></a>Generate static files</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></div></figure>

<p>More info: <span class="exturl"><a class="exturl__link"   href="https://hexo.io/docs/generating.html"  target="_blank" rel="noopener">Generating</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="Deploy-to-remote-sites"   >
          <a href="#Deploy-to-remote-sites" class="heading-link"><i class="fas fa-link"></i></a>Deploy to remote sites</h3>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></div></figure>

<p>More info: <span class="exturl"><a class="exturl__link"   href="https://hexo.io/docs/one-command-deployment.html"  target="_blank" rel="noopener">Deployment</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><span class="page-number current">1</span></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/logo.png" alt="avatar"></div><p class="sidebar-ov-author__text">NewJerseyStyle</p></div><div class="sidebar-ov-feed"><span class="sidebar-ov-feed-rss"><a class="sidebar-ov-feed-rss__link" href="/atom.xml" target="_blank" rel="noopener"><span class="sidebar-ov-feed-rss__icon"><i class="fas fa-rss"></i></span><span>RSS Subscribe</span></a></span></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">16</div><div class="sidebar-ov-state-item__name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-sa/4.0/deed.en zh-tw" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2020</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>NewJerseyStyle</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zIndex="-1"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ Untitled ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);</script><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async=""></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-9667639204764993',
  enable_page_level_ads: true
});</script><script src="/js/utils.js?v=2.0.0-rc.0"></script><script src="/js/stun-boot.js?v=2.0.0-rc.0"></script><script src="/js/scroll.js?v=2.0.0-rc.0"></script><script src="/js/header.js?v=2.0.0-rc.0"></script><script src="/js/sidebar.js?v=2.0.0-rc.0"></script>
        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        $('a').each(function() {
          const $this = $(this);
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'newjerseystyle.github.io' || window.location.host) {
                    $this.attr('href', '/redirect_page.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (false) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script></body></html>